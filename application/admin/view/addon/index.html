<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <title>TwelveT 插件商城</title>
    <link rel="stylesheet" href="__STATIC__/lib/layui/css/layui.css">
    <link rel="stylesheet" href="__STATIC__/lib/font-awesome.css">
    <script type="text/javascript" src="__STATIC__/lib/layui/layui.js"></script>
    <style>
        body{ padding: 20px}
        a{outline: none;border:0}
    </style>
</head>
<body>
    
    <table id='data' lay-filter='data'></table>

    <script type="text/html" id="drTool">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="locaInstall" id='locaInstall'><i class='fa fa-upload'></i>离线安装</button>
        </div>
    </script>

    <script type="text/html" id="operation">
        <a class="layui-btn layui-btn-xs" lay-event="edit">配置</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">卸载</a>
    </script>

    <script type='text/html' id='home'>
        <a href="{{d.url}}" target='_blank'><i class='fa fa-desktop'></i></a>
    </script>

    <script type="text/html" id="state">
        <input type="checkbox" name="state" value="{{d.name}}" lay-skin="switch" lay-text="启用|禁用" lay-filter="state" {{ d.state == 1 ? 'checked' : '' }}>
    </script>

    <script>
        layui.use(['table', 'upload', 'layer', 'notice'], function(){
            //获取模块
            var table = layui.table,
            form = layui.form,
            upload = layui.upload,
            layer = layui.layer,
            notice = layui.notice,
            $ = layui.jquery;
            
            $.ajax({
                ur: '/love.php/addon.html',
                type: 'post',
                data: {
                    data: 'nice',
                    url: 'item'
                },
                success: function(){
                    alert('成功映入');
                }
            })


            table.render({
                elem: '#data',
                url:'{:url("downloaded")}',
                id: 'data',
                toolbar: '#drTool',
                cellMinWidth: 80, //全局定义常规单元格的最小宽度
                cols: [[
                    {field: 'url',title: '前台', templet: '#home', width: 50, align: 'center'},
                    {field: 'title',minWidth: 300 , title: '插件名称', align: 'center'},
                    {field: 'intro', title: '插件简介', align: 'center'},
                    {field: 'author', title: '作者', align: 'center'},
                    {field: 'price', title: '价格', align: 'center'},
                    {field: 'version', title: '版本', align: 'center'},
                    {field: 'downloads', title: '下载次数', align: 'center'},
                    {field: 'state', title: '状态', width: 100, templet: '#state', align: 'center'},
                    {title: '操作', toolbar: '#operation', width: 150, align: 'center'}
                ]],
                page: true
            });
            
            //解决数据重载后事件绑定失效
            var drivingTool = function(){
                //离线安装接口
                upload.render({
                    elem: '#locaInstall',
                    url: '{:url("localInstall")}',
                    field: 'package',
                    accept: 'file',
                    exts: 'zip',
                    size : 10000,
                    before: function(obj) {
                        loading = layer.load();
                    },
                    done: function(res){
                        layer.close(loading);
                        if(res.state){
                            notice.success(res.msg);
                            table.reload('data', {
                                done: function(){
                                    //重新执行事件绑定
                                    drivingTool()
                                }
                            })
                        }else{
                            notice.error(res.msg);
                        }
                    },
                    error: function(index, upload){
                        layer.close(loading);
                        notice.error('上传失败,请检查上传接口');
                    }
                });
            }

            //监听单元操作
            table.on('tool(data)', function(obj){
                var data = obj.data;
                if(obj.event === 'del'){
                    var confirmMsg =    '<div>\
                                            卸载：'+ data.title +'<br>\
                                            请自行检查数据沉余，部分需要手动清理<br>\
                                            <span style="color:red">重要数据请做好备份，完成执行后所有数据都将不可逆！</span>\
                                        </div>';
                    layer.confirm(confirmMsg, function(item){
                        //发送ajax删除
                        $.ajax({
                                url : '{:url("uninstall")}',
                                type : 'post',
                                data : 'title=' + data.title + '&name=' + data.name + '&force=' + 'false',
                                dataType : 'json',
                                beforeSend : function(){
                                    loading = layer.load(0);
                                },
                                success : function(result){
                                    //关闭加载动画
                                    layer.close(loading);
                                    //提示删除信息
                                    notice.success(result.msg);
                                    //实时更新
                                    obj.del();
                                    //关闭
                                    layer.close(item);
                                }
                            });
                    });
                } else if(obj.event === 'edit'){
                    modfyIframe = layer.open({
                        type : 2,
                        title : '配置信息',
                        maxmin: true,
                        content : '{:url("config")}' + '?name=' + data.name,
                        area : ['90%' , '95%']
                    })
                }
            });

            //监听状态启用，禁用
            form.on('switch(state)', function(obj){
                //判断操作方式
                var action = '';
                if(obj.elem.checked){
                    action = 'enable';
                }else{
                    action = 'disable';
                }
                //发送ajax请求状态
                $.ajax({
                    url : '{:url("state")}',
                    type : 'post',
                    data : 'name=' + this.value + '&action=' + action + '&force=false',
                    dataType : 'json',
                    beforeSend : function(){
                        loading = layer.load(0);
                    },
                    success : function(result){
                        //关闭加载动画
                        layer.close(loading);
                        //提示信息
                        notice.success(result.msg);
                    }
                })
            });

            //执行第一次的事件绑定
            drivingTool();
        });    
    </script>
</body>
</html>